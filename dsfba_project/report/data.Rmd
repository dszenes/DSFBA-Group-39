# 2 Data

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## Raw Data Set

<br>

## 2.1 Crime Data

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
First, we will load two data sets that record the incident reports that have been filed to the police.
</div>

<br>

### 2.1.1 2018 To Present
```{r}
data2 <- read_csv(file = here::here("data/Police_Department_Incident_Reports__2018_to_Present.csv"))
data2 <- as_tibble(data2)
```
<br>
_Source of the data set:_ [https://data.sfgov.org/Public-Safety/Police-Department-Incident-Reports-2018-to-Present/wg3w-h783]

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

This dataset covers the period from the 1st January 2018 to the day in 2020 where we've downloaded the data and contains about 408K observations.

</div>

<br>

* We will focus on these variables:`Incident Date`, `Incident Time`, `Incident Day of Week`, `Incident Category`, `Resolution`, `Analysis Neighborhood`, `point`.


  + `Incident Datetime` The date and time when the incident occurred
  + `Incident Date` The date the incident occurred
  + `Incident Time` The time the incident occurred
  + `Incident Year` The year the incident occurred, provided as a convenience for filtering
  + `Incident Day of Week`The day of week the incident occurred
  + `Report Datetime` Distinct from Incident Datetime, Report Datetime is when the report was filed.
  + `Incident Category` A category mapped on to the Incident Code used in statistics and reporting.
  + `Incident Subcategory` A subcategory mapped to the Incident Code that is used for statistics and reporting.
  + `Incident Description` The description of the incident that corresponds with the Incident Code.
  + `Resolution` The resolution of the incident at the time of the report.
  + `Analysis Neighborhood` This field is used to identify the neighborhood where each incident occurs. Neighborhoods and boundaries are defined by the Department of Public Health and the Mayor's Office of Housing and Community Development. Please reference the link below for additional info: [https://data.sfgov.org/d/p5b7-5n3h].
  + `Latitude` The latitude coordinate
  + `Longitude` The longitude coordinate
  + `point` The point geometry used for mapping features in the open data portal platform. Latitude and Longitude are provided separately as well as a convenience.


<br>
In order to be able to join the two datasets that have a different temporality and thus focus on variables to answer the chosen research questions, we have removed a few columns. 
<br>
This information will be useful to us in order to look at the evolution of crime over time and also to analyze crime by neighborhood and thus be able to analyze whether this variation in crime across neighborhoods can be explained by socio-economic variables.
<br><br>

### 2.1.2 2003 To 2018

```{r}
data1 <- read_csv(file = here::here("data/Police_Department_Incident_Reports__Historical_2003_to_May_2018.csv")) 
data1 <- as_tibble(data1)
```
_Source of the data set:_ [https://data.sfgov.org/Public-Safety/Police-Department-Incident-Reports-Historical-2003/tmnf-yvry]
<br>

This dataset covers the period from the 1st January 2003 to the 15th May 2018 and contains about 2.16M observations

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
As for the 3.1.1 data set, we will focus on these variables:`Incident Category`, `DayOfWeek`, `DayOfWeek`, `Date`, `Time`, `Resolution`, `Y`, `X`, `location`,`Analysis Neighborhoods 2 2`.
</div>

  + `Incident Category` A category mapped on to the Incident Code used in statistics and reporting.
  + `Descript` The description of the incident that corresponds with the Incident Code.
  + `DayOfWeek` The day of week the incident occurred
  + `Date` The date the incident occurred
  + `Time` The time the incident occurred
  + `Resolution` The resolution of the incident at the time of the report.
  + `Y` The latitude coordinate
  + `X` The longitude coordinate
  + `location` The point geometry used for mapping features in the open data portal platform. Latitude and Longitude are provided separately as well as a convenience.
  + `Analysis Neighborhoods 2 2` This field is used to identify the neighborhood where each incident occurs. Neighborhoods and boundaries are defined by the Department of Public Health and the Mayor's Office of Housing and Community Development. Please reference the link below for additional info: [https://data.sfgov.org/d/p5b7-5n3h].

<br><br>

For the `Analysis Neighborhoods 2 2`, we had to harmonize the numbers found in this column with the neighborhood names and make sure that we had the correct ones.

<br>

## 2.2 Socio-Economic Data

<br>

### 2.2.1 2012 To 2016

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
Then, we will load four data sets that record the evolution of some socio-economic variables for each neighborhood of San Francisco. As these reports - built with census data - were only exported in pdf format, we decided to create our own data set in csv in order to use the information from these reports for different periods.
</div>

```{r}
data3 <- read_csv(file = here::here("data/American_Community_Survey_2012-2016.csv"))
data3 <- as_tibble(data3)

```
_Source of the data set:_ [https://default.sfplanning.org/publications_reports/SF_NGBD_SocioEconomic_Profiles/2012-2016_ACS_Profile_Neighborhoods_Final.pdf]

### 2.2.2 2010 To 2014

```{r}
data4 <- read_csv(file = here::here("data/American_Community_Survey_2010-2014.csv"))
data4 <- as_tibble(data4)
```
_Source of the data set:_ [https://default.sfplanning.org/publications_reports/SF_NGBD_SocioEconomic_Profiles/2011-2015_ACS_Profile_Neighborhoods_Final.pdf]


### 2.2.3 2011 To 2015

```{r}
data5 <- read_csv(file = here::here("data/American_Community_Survey_2011-2015.csv"))
data5 <- as_tibble(data5)
```
_Source of the data set:_ [https://default.sfplanning.org/publications_reports/SF_NGBD_SocioEconomic_Profiles/2010-2014_ACS_Profile_Neighborhoods_v3AH.pdf]

### 2.2.4 2005 To 2009

```{r}
data6 <- read_csv(file = here::here("data/American_Community_Survey_2005-2009.csv"))
data6 <- as_tibble(data6)
```
_Source of the data set:_ [https://sf-planning.org/sites/default/files/FileCenter/Documents/8501-SFProfilesByNeighborhoodForWeb.pdf]

<br>

* Column of the data sets:

  + `NEIGHBOORHOD` Each neighborhood of San Franciso. Segmented using the geospatial data in this link : [https://data.sfgov.org/Geographic-Locations-and-Boundaries/Analysis-Neighborhoods/p5b7-5n3h]
  + `Time Horizon` This column highlights the time horizon where the data have been collected.
  + `Total Population` This column highlights the total population for each neighbourhood.
  + `Households` This column highlights the total households number for each neighbourhood.
  + `Family Households` This column highlights the proportion of family-households within a neighborhood.
  + `Non-Family Households` This column highlights the proportion of non-family-households within a neighbourhood
  + `Average Household Size` This column highlights the average household size for each neighbourhood.
  + `Asian` proportion of Asian people within the neighborhood
  + `Black/African American` proportion of Black/African American people within the neighborhood
  + `White` proportion of White people within the neighborhood
  + `Native American Indian` proportion of Native American Indian people within the neighborhood
  + `Native Hawaiian/Pacific Islander` proportion of Native Hawaiian/Pacific Islander people within the neighborhood
  + `Other/Two or More Races` proportion of Other/Two or More Races people within the neighborhood
  + `Latino (of Any Race)` proportion of Latino (of Any Race)  people within the neighborhood
  + `0-4 years` proportion of people with age = [0-4] within the neighborhood
  + `5-17 years` proportion of people with age = [5-17] within the neighborhood
  + `18-34 years` proportion of people with age = [18-34] within the neighborhood
  + `35-59 years` proportion of people with age = [35-59] within the neighborhood
  + `60 and older` proportion of people with age = [60-older] within the neighborhood
  + `Median Age` This column highlights the median age  within a neighbourhood
  + `High School or Less` proportion of people with only a High School degree or less within the neighborhood
  + `Some College/Associate Degree` proportion of people with only associate College degree or less within the neighborhood
  + `College Degree` proportion of people with only College Degree within the neighborhood
  + `Graduate/Professional Degree`  proportion of people with only Graduate/Professional Degree within the neighborhood
  + `Foreign Born` proportion of foreign born people within the neighborhood
  + `English Only` proportion of english only speakers people within the neighborhood
  + `Spanish Only` proportion of spanish only speakers people within the neighborhood
  + `Asian/Pacific Islander` proportion of asian only speakers people within the neighborhood
  + `Other European Languages Only` proportion of european languages only speakers people within the neighborhood
  + `Other Languages` proportion of other languages only speakers people within the neighborhood
  + `Units of Housing` this column highlights the number of housings for each neighbourhood.
  + `Median Year Structure Build` this column highlights the median year structure housing  for each neighbourhood.
  + `Median Rent` this column highlights the median housing rent for each neighbourhood.
  + `Median Home Value` this column highlights the median home value for each neighbourhood.
  + `Median Household Income` this column highlights the median household income for each neighbourhood.
  + `Percent in Poverty` this column highlights the % in poverty  for each neighbourhood.
  + `Unemployment Rate` this column highlights the % of unemployment for each neighbourhood.
  + `Population Density per Acre` this column highlights the number of people per Acre for each neighborhood.
  
  <br>
  
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
With all these variables, we can see each neighborhood in terms of the number and density of the population, household composition, race, age distribution, education, languages spoken, and the economy of the neighborhood. This will be very helpful for answering some of our research questions.
</div>
  
  <br>
  
## 2.3 Transportio  Data
### 2.3.1 Public transportion

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
Next, we will upload a dataset that counts the number of transit stops in SFMTA system. We will use this data to analyze the transit situation by neighborhood.
</div>

```{r}
data8 <- read_csv(file = here::here("data/Muni_Stops.csv"))
```
_Source of the data set:_ [https://catalog.data.gov/dataset/muni-stops].

<br>
  
* Here are the columns we are going to focus on::
  + `STOPNAME` The names of all the transit stops
  + `shape` The point geometry used for mapping features
  + `Analysis Neighborhoods` This column indicates in which neighborhood of San Franciso the transit stops is.
  
<br>
    
_The other columns of this data set are not relevant for our reasearch project. We will only use this data set to see if the density of the number of public transport stops coincides with the neighborhoods with the most crime.
This data set will also be useful to analyze the density of the public transport network and find a comparison with the neighbourhoods with the most crime._

<br>
    
## 2.4 Geospacial Data

### 2.4.1 Neighborhoods

```{r}
data9 <-
  st_read(dsn = here::here("data/Analysis Neighborhoods.geojson"))
data9 %>% arrange(nhood)
st_crs(data9 %>% arrange(nhood))
data9bis <- st_transform(data9 %>% arrange(nhood), crs = 2227)
neigh <- st_transform(data9bis, crs = "+proj=longlat +datum=WGS84")
```
_Source of the data set:_ [https://data.sfgov.org/Geographic-Locations-and-Boundaries/Analysis-Neighborhoods/p5b7-5n3h]

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
This data set contains multi-polygons that are supposed to represent the segmentation of neighbourhoods corresponding to the Analysis Neighborhood variable. We will use this data set extensively for our geospatial analyses.
</div>

```{r}
data10 <-
  read_csv(file = here::here(
    "data/COVID-19_Cases_and_Deaths_Summarized_by_Geography.csv"
  ))
covid_neighborhoods <- data10 %>% 
  filter(area_type == "Analysis Neighborhood", !(is.na(`rate`))) %>%
  select(id, count, rate)
```

```{r}
data11 <- read_csv(file = here::here("data/COVID-19_Cases_Summarized_by_Date__Transmission_and_Case_Disposition.csv")) 
data11 <- as_tibble(data11) 

covid_sf <- data11 %>% 
  group_by(`Specimen Collection Date`) %>%
  summarise(`Case Count` = sum(`Case Count`)) %>%
  filter(  `Specimen Collection Date` <= as.Date("2020-11-13") &
           `Specimen Collection Date` >= as.Date("2020-03-10") ) %>%
  rename(date = `Specimen Collection Date`)
```
<br><br>

## 2.5 Data Set Cleaning
##### 2.5.1 2003-2020 Crime
```{r}
data2$`Analysis Neighborhood`[data2$`Analysis Neighborhood` == "Castro/UpperMarket"] <- "Castro/Upper Market"

data2$`Analysis Neighborhood`[data2$`Analysis Neighborhood` == "Financial District/South Beach"] <- "Financial District"

data2$`Analysis Neighborhood`[data2$`Analysis Neighborhood` == "Lone Mountain/USF"] <- "Lone Mountain"

data2$`Analysis Neighborhood`[data2$`Analysis Neighborhood` == "Pacific Heights"] <- "Pacific Heights"



crime2018_2020 <-
  data2 %>% select(
    `Incident Date`,
    `Incident Time`,
    `Incident Day of Week`,
    `Incident Category`,
    `Incident Description`,
    `Resolution`,
    point,
    `Analysis Neighborhood`
  ) %>%
  separate(point, into = c("lon", "lat"), sep = "[,]+")
#select the variable that we're interested in (time horizon 2018-2020)

crime2018_2020$`Analysis Neighborhood`[crime2018_2020$`Analysis Neighborhood` == "Mission"] <- "Mission Bay"
#rename the rows in the column Analysis Neighborhood, in order have the same neighboorhood in the two data set

crime2018_2020$lat = substr(crime2018_2020$lat, 2 , nchar(crime2018_2020$lat) - 1)
crime2018_2020$lon = substr(crime2018_2020$lon, 2 , nchar(crime2018_2020$lon))
options(digits = 13)
crime2018_2020$lat <- sapply(crime2018_2020$lat, as.numeric)
crime2018_2020$lon <- sapply(crime2018_2020$lon, as.numeric)
#Clean some of the column in order to make geospacial representation
```

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
Here is our cleaned data set which takes into account all crimes from 2003 to 2020. We highlight the first 5 observations. We will use it to look at the trends for crime.
</div>

<br>

```{r}
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "1"] <- "Bayview Hunters Point"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "2"] <- "Bernal Heights"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "3"] <- "Haight Ashbury"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "4"] <- "Mission Bay"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "5"] <- "Castro/UpperMarket"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "6"] <- "Chinatown"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "7"] <- "Excelsior"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "8"] <- "Financial District"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "9"] <- "Hayes Valley"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "10"] <- "Glen Park"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "11"] <- "Inner Richmond"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "12"] <- "Golden Gate Park"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "13"] <- "Marina"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "14"] <- "Inner Sunset"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "15"] <- "Japantown"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "16"] <- "Lakeshore"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "17"] <- "Lincoln Park"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "18"] <- "Lone Mountain"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "19"] <- "McLaren Park"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "20"] <- "Mission"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "21"] <- "Nob Hill"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "22"] <- "Noe Valley"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "23"] <- "North Beach"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "24"] <- "Oceanview/Merced/Ingleside"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "25"] <- "Portola"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "26"] <- "Potrero Hill"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "27"] <- "Presidio"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "28"] <- "Outer Mission"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "29"] <- "Outer Richmond"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "30"] <- "Pacific Height"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "31"] <- "Presidio Heights"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "32"] <- "Russian Hill"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "33"] <- "Seacliff"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "34"] <- "South of Market"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "35"] <- "Sunset/Parkside"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "36"] <- "Tenderloin"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "37"] <- "Treasure Island"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "38"] <- "Twin Peaks"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "39"] <- "Visitacion Valley"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "40"] <- "Western Addition"
data1$`Analysis Neighborhoods 2 2`[data1$`Analysis Neighborhoods 2 2` == "41"] <- "West of Twin Peaks"
#change the `Analysis Neighborhoods 2 2` values. In the raw dataset, each neighborhood is characterized by a number. These code lines are used to assign the neighborhood names to each number.

data1_colchange <- data1 %>% mutate(Date = mdy(Date)) %>% 
  rename(
    `Incident Date` = Date,
    `Incident Time` = Time,
    `Incident Day of Week` = DayOfWeek,
    `Incident Category` = Category,
    `Incident Description` = Descript,
    `Analysis Neighborhood` = `Analysis Neighborhoods 2 2`,
    point = location
  ) %>%
  separate(point, into = c("point","lon", "lat"), sep = "[ ]+")

data1_colchange$lat = substr(data1_colchange$lat, 1 , nchar(data1_colchange$lat) - 1)
data1_colchange$lon = substr(data1_colchange$lon, 2 , nchar(data1_colchange$lon))
options(digits = 13)
data1_colchange$lat <- sapply(data1_colchange$lat, as.numeric)
data1_colchange$lon <- sapply(data1_colchange$lon, as.numeric)
#change the column name of the data set with horizon 2003-2018 in order to bind the 2 data set

crime2003_2018 <-
  data1_colchange %>% filter(`Incident Date` >= as.Date("2003-01-01"), `Incident Date` <= as.Date("2018-01-01")) %>% select(
    `Incident Date`,
    `Incident Time`,
    `Incident Day of Week`,
    `Incident Category`,
    `Incident Description`,
    Resolution,
    lat,
    lon,
    `Analysis Neighborhood`
  )
#select the variable that we're interested in and removing the information we already have in the other data set

crime2003_2020 <- bind_rows(crime2018_2020, crime2003_2018)
#bind both data set


crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` == "ARSON"] <-
  "Arson"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "ASSAULT"] <- "Assault"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "BURGLARY"] <- "Burglary"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "DISORDERLY CONDUCT"] <- "Disorderly Conduct"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Drug Offense"] <- "Drugs/Narcotics"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Drug Violation"] <- "Drugs/Narcotics"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "DRUG/NARCOTIC"] <- "Drugs/Narcotics"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "EMBEZZLEMENT"] <- "Embezzlement"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "FAMILY OFFENSES"] <- "Family Offense"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Offences Against The Family And Children"] <- "Family Offense"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Forgery And Counterfeiting"] <- "Forgery/Counterfeiting"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "FORGERY/COUNTERFEITING"] <- "Forgery/Counterfeiting"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "FRAUD"] <- "Fraud"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "GAMBLING"] <- "Gambling"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Human Trafficking (A), Commercial Sex Acts"] <- "Human Trafficking"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Human Trafficking (B), Involuntary Servitude"] <-
  "Human Trafficking"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Human Trafficking, Commercial Sex Acts"] <- "Human Trafficking"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "LIQUOR LAWS"] <- "Liquor Laws"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Larceny Theft"] <- "Larceny/Theft"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "LARCENY/THEFT"] <- "Larceny/Theft"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "MISSING PERSON"] <- "Missing Person"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Motor Vehicle Theft?"] <- "Motor Vehicle Theft"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "VEHICLE THEFT"] <- "Motor Vehicle Theft"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "NON-CRIMINAL"] <- "Non-Criminal"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Other Miscellaneous"] <- "Other"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Other Offenses"] <- "Other"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "OTHER OFFENSES"] <- "Other"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "PROSTITUTION"] <- "Prostitution"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "RECOVERED VEHICLE"] <- "Recovered Vehicle"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "ROBBERY"] <- "Robbery"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Rape"] <- "Sexual Assault"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "SEX OFFENSES, FORCIBLE"] <- "Sexual Assault"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Sex Offense"] <- "Other Sex Offense"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "SEX OFFENSES, NON FORCIBLE"] <- "Other Sex Offense"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "PORNOGRAPHY/OBSCENE MAT"] <- "Other Sex Offense"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "STOLEN PROPERTY"] <- "Stolen Property"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "SUICIDE"] <- "Suicide"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Suspicious"] <- "Suspicious occurence"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Suspicious Occ"] <- "Suspicious occurence"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "VANDALISM"] <- "Vandalism"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "WARRANTS"] <- "Warrant"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "WEAPON LAWS"] <- "Weapon laws"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Weapons Carrying Etc"] <- "Weapon laws"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Weapons Offence"] <- "Weapon laws"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Weapons Offense"] <- "Weapon laws"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "TREA"] <- "Trespassing"
crime2003_2020$`Incident Category`[crime2003_2020$`Incident Category` ==
                                     "Tresspassing"] <- "Trespassing"
#harmonize the categories in the regrouped dataset

crime2003_2020$Resolution[crime2003_2020$Resolution ==
                                     "Cite or Arrest Adult"] <- "ARREST, CITED"
crime2003_2020$Resolution[crime2003_2020$Resolution ==
                                     "Open or Active"] <- "OPEN"
crime2003_2020$Resolution[crime2003_2020$Resolution ==
                                     "Unfounded"] <- "NONE"
crime2003_2020$Resolution[crime2003_2020$Resolution ==
                                     "Exceptional Adult"] <- "ARREST, CITED"
#harmonize the resolutions in the regrouped dataset


kable(head(crime2003_2020))

```

_As you can see here, there are a few NA values for the latitude and longitude variables. For the purpose of creating a time series graph, this is not a problem, and thus we can keep them. However, for  geospacial visualization, we're going create a table where these NA values are removed._



<br><br>

##### 2.5.2 Transportation
<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
Here is our cleaned data set that counts the number of public transportation stops in San Francisco. We took the time to modify the numbers associated to each neighborhood by changing them with their associated names. We will use this data set to see if there is a correlation between crime and public transportion density.
</div>

<br>
```{r}
p <- data8 %>% separate(shape, into = c("point","lon", "lat"), sep = "[ ]+") #separate the geo information from the shape column in order to make a longitude and a latitude column.

p$lat = substr(p$lat, 1 , nchar(p$lat) - 1)
p$lon = substr(p$lon, 2 , nchar(p$lon))
#remove unnecessary characters

options(digits = 6)
p$lat <- sapply(p$lat, as.numeric)
p$lon <- sapply(p$lon, as.numeric)
#change the column type: from chr to num

transport <- p %>% select("STOPNAME", "lat", "lon","Analysis Neighborhoods") %>% filter(!(is.na(`Analysis Neighborhoods`)))
#select the variable of interest while removing the NA values if a transport stops is not characterized by his neighborhood
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "1"] <- "Bayview Hunters Point"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "2"] <- "Bernal Heights"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "3"] <- "Haight Ashbury"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "4"] <- "Mission Bay"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "5"] <- "Castro/UpperMarket"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "6"] <- "Chinatown"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "7"] <- "Excelsior"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "8"] <- "Financial District"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "9"] <- "Hayes Valley"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "10"] <- "Glen Park"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "11"] <- "Inner Richmond"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "12"] <- "Golden Gate Park"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "13"] <- "Marina"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "14"] <- "Inner Sunset"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "15"] <- "Japantown"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "16"] <- "Lakeshore"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "17"] <- "Lincoln Park"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "18"] <- "Lone Mountain"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "19"] <- "McLaren Park"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "20"] <- "Mission"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "21"] <- "Nob Hill"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "22"] <- "Noe Valley"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "23"] <- "North Beach"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "24"] <- "Oceanview/Merced/Ingleside"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "25"] <- "Portola"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "26"] <- "Potrero Hill"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "27"] <- "Presidio"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "28"] <- "Outer Mission"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "29"] <- "Outer Richmond"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "30"] <- "Pacific Height"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "31"] <- "Presidio Heights"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "32"] <- "Russian Hill"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "33"] <- "Seacliff"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "34"] <- "South of Market"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "35"] <- "Sunset/Parkside"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "36"] <- "Tenderloin"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "37"] <- "Treasure Island"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "38"] <- "Twin Peaks"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "39"] <- "Visitacion Valley"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "40"] <- "Western Addition"
transport$`Analysis Neighborhoods`[transport$`Analysis Neighborhoods` == "41"] <- "West of Twin Peaks"
#change the `Analysis Neighborhoods` values. In the raw dataset, each neighborhood is characterized by a number. These code lines are used to assign the neighborhood names to each number.
numstops <- transport %>% count(`Analysis Neighborhoods`, name = "number of stops") %>% arrange(desc(`number of stops`))

kable(head(numstops), "simple")
```
<br><br>

##### 2.5.3 Socio-Economic & Crime Data Combined
<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
This data set highlights the number of crimes by neighborhood for the years 2014 to 2016. We have combined the crime information with our socio-economic data. This dataset will be useful to build a linear regression as well as for the geospatial analysis.
</div>

<br>

```{r}
crime2003_2020_datesep <- crime2003_2020 %>%
  mutate(day  = day(`Incident Date`), month = month(`Incident Date`, label = TRUE),
         year  = year(`Incident Date`)) %>% select(-`Incident Date`)
```

```{r}
# We will focus our deepest statistical analysis on the year 2016 because that is when we have the most recent socio-economic and demographic data
crime_2016 <- crime2003_2020_datesep %>% 
  filter(year == 2016)

crime_2016_neighborhood <- crime2003_2020_datesep %>% 
  filter(year == 2016, !(is.na(`Analysis Neighborhood`))) %>%
  count(`Analysis Neighborhood`, name = "Total crimes")

violent_crime_2016_neighborhood <- crime2003_2020_datesep %>%
  filter(year == 2016,!(is.na(`Analysis Neighborhood`)),`Incident Category` %in% c("Assault", "Homicide", "Robbery", "Sexual Assault") | `Analysis Neighborhood` == "Presidio") %>% count(`Analysis Neighborhood`, name = "Violent crimes")
violent_crime_2016_neighborhood$`Violent crimes`[violent_crime_2016_neighborhood$`Violent crimes` == "51"] <- 0

#We select the Assault, Homicide, Sexual Assault and Robbery  categories for a sub-category called Violent crimes
demostats_2016 <- data3[-c(42,43,44,45,46,47,48), ]

crime_demostats_2016 <-
  bind_cols(violent_crime_2016_neighborhood,
            crime_2016_neighborhood,
            demostats_2016, neigh, numstops) %>%
  mutate(
    `Family Households` = `Family Households` * `Total Population`,
    `Non-Family Households` = `Non-Family Households` * `Total Population`,
    `Asian` = `Asian` * `Total Population`,
    `Black/African American` = `Black/African American` * `Total Population`,
    `White` = `White` * `Total Population`,
    `Native American Indian` = `Native American Indian` * `Total Population`,
    `Native Hawaiian/Pacific Islander` = `Native Hawaiian/Pacific Islander` * `Total Population`,
    `Other/Two or More Races` = `Other/Two or More Races` * `Total Population`,
    `Latino (of Any Race)` = `Latino (of Any Race)` * `Total Population`,
    `0-4 years` = `0-4 years` * `Total Population`,
    `5-17 years` = `5-17 years` * `Total Population`,
    `18-34 years` = `18-34 years` * `Total Population`,
    `35-59 years` = `35-59 years` * `Total Population`,
    `60 and older` = `60 and older` * `Total Population`,
    `High School or Less` = `High School or Less` * `Total Population`,
    `Some College/Associate Degree` = `Some College/Associate Degree` * `Total Population`,
    `College Degree` = `College Degree` * `Total Population`,
    `Foreign Born` = `Foreign Born` * `Total Population`,
    `English Only` = `English Only` * `Total Population`,
    `Spanish Only` = `Spanish Only` * `Total Population`,
    `Asian/Pacific Islander` = `Asian/Pacific Islander` * `Total Population`,
    `Other European Languages` = `Other European Languages` * `Total Population`,
    `Other Languages` = `Other Languages` * `Total Population`,
    `Number of people Poverty` = `Percent in Poverty` * `Total Population`,
    `Unemployed population` = `Unemployment Rate` * `Total Population`,
    `Graduate/Professional Degree` = `Graduate/Professional Degree` * `Total Population`
  ) %>%
  rename(`Analysis Neighborhood` = `NEIGHBORHOOD`) %>%
  select(everything(), -(`Time Horizon`),-(`Analysis Neighborhood...1`), -(`Analysis Neighborhood...3`), -(nhood), -(`Analysis Neighborhoods`)) %>% arrange(`Analysis Neighborhood`)

crime_demostats_2016 <- crime_demostats_2016[, c(-38, -39, -41)]
```

```{r}
# We will focus our deepest statistical analysis on the year 2016 because that is when we have the most recent socio-economic and demographic data
crime_2014 <- crime2003_2020_datesep %>%
  filter(year == 2014)
crime_2014_neighborhood <- crime2003_2020_datesep %>%
  filter(year == 2014,!(is.na(`Analysis Neighborhood`))) %>%
  count(`Analysis Neighborhood`, name = "Total crimes")
violent_crime_2014_neighborhood <- crime2003_2020_datesep %>%
  filter(
    year == 2014,
    !(is.na(`Analysis Neighborhood`)),
    `Incident Category` %in% c("Assault", "Homicide", "Robbery", "Sexual Assault") |
      `Analysis Neighborhood` == "Lincoln Park"
  ) %>% count(`Analysis Neighborhood`, name = "Violent crimes")
crime_2015 <- crime2003_2020_datesep %>%
  filter(year == 2015)
crime_2015_neighborhood <- crime2003_2020_datesep %>%
  filter(year == 2015,!(is.na(`Analysis Neighborhood`))) %>%
  count(`Analysis Neighborhood`, name = "Total crimes")
violent_crime_2015_neighborhood <- crime2003_2020_datesep %>%
  filter(
    year == 2015,
    !(is.na(`Analysis Neighborhood`)),
    `Incident Category` %in% c("Assault", "Homicide", "Robbery", "Sexual Assault")
  ) %>% count(`Analysis Neighborhood`, name = "Violent crimes")
crime_2016 <- crime2003_2020_datesep %>%
  filter(year == 2016)
crime_2016_neighborhood <- crime2003_2020_datesep %>%
  filter(year == 2016,!(is.na(`Analysis Neighborhood`))) %>%
  count(`Analysis Neighborhood`, name = "Total crimes")
violent_crime_2016_neighborhood <- crime2003_2020_datesep %>%
  filter(
    year == 2016,
    !(is.na(`Analysis Neighborhood`)),
    `Incident Category` %in% c("Assault", "Homicide", "Robbery", "Sexual Assault") |
      `Analysis Neighborhood` == "Presidio"
  ) %>% count(`Analysis Neighborhood`, name = "Violent crimes")
crime_2014_2016_neighborhood <-
  bind_rows(crime_2014_neighborhood,
            crime_2015_neighborhood,
            crime_2016_neighborhood)
violent_crime_2016_neighborhood$`Violent crimes`[violent_crime_2016_neighborhood$`Violent crimes` == "51"] <-
  0
violent_crime_2014_neighborhood$`Violent crimes`[violent_crime_2014_neighborhood$`Violent crimes` == "14"] <-
  0
violent_crime_2014_2016_neighborhood <-
  bind_rows(
    violent_crime_2014_neighborhood,
    violent_crime_2015_neighborhood,
    violent_crime_2016_neighborhood
  )
violent_crime_2014_2016_neighborhood <-
  violent_crime_2014_2016_neighborhood[-1]
#We select the Assault, Homicide, Sexual Assault and Robbery  categories for a sub-category called Violent crimes
demostats_2016 <- data3[-42,]
demostats_2015 <- data5[-42,]
demostats_2014 <- data4[-42,]
demostats_2014_2016 <-
  bind_rows(demostats_2014, demostats_2015, demostats_2016)
demostats_2014_2016 <- demostats_2014_2016[-1]
demostats_2014_2016 <- demostats_2014_2016[-c(124:129), ]
numstops_2014_2016 <- bind_rows(numstops, numstops, numstops)
numstops_2014_2016 <- numstops_2014_2016[-1]
crime_demostats_2014_2016 <-
  bind_cols(
    violent_crime_2014_2016_neighborhood,
    crime_2014_2016_neighborhood,
    demostats_2014_2016,
    numstops_2014_2016
  ) %>%
  mutate(
    `Family Households` = `Family Households` * `Total Population`,
    `Non-Family Households` = `Non-Family Households` * `Total Population`,
    `Asian` = `Asian` * `Total Population`,
    `Black/African American` = `Black/African American` * `Total Population`,
    `White` = `White` * `Total Population`,
    `Native American Indian` = `Native American Indian` * `Total Population`,
    `Native Hawaiian/Pacific Islander` = `Native Hawaiian/Pacific Islander` * `Total Population`,
    `Other/Two or More Races` = `Other/Two or More Races` * `Total Population`,
    `Latino (of Any Race)` = `Latino (of Any Race)` * `Total Population`,
    `0-4 years` = `0-4 years` * `Total Population`,
    `5-17 years` = `5-17 years` * `Total Population`,
    `18-34 years` = `18-34 years` * `Total Population`,
    `35-59 years` = `35-59 years` * `Total Population`,
    `60 and older` = `60 and older` * `Total Population`,
    `High School or Less` = `High School or Less` * `Total Population`,
    `Some College/Associate Degree` = `Some College/Associate Degree` * `Total Population`,
    `College Degree` = `College Degree` * `Total Population`,
    `Foreign Born` = `Foreign Born` * `Total Population`,
    `English Only` = `English Only` * `Total Population`,
    `Spanish Only` = `Spanish Only` * `Total Population`,
    `Asian/Pacific Islander` = `Asian/Pacific Islander` * `Total Population`,
    `Other European Languages` = `Other European Languages` * `Total Population`,
    `Other Languages` = `Other Languages` * `Total Population`,
    `Number of people Poverty` = `Percent in Poverty` * `Total Population`,
    `Unemployed population` = `Unemployment Rate` * `Total Population`,
    `Graduate/Professional Degree` = `Graduate/Professional Degree` * `Total Population`
  ) %>%
  select(
    everything(),
    -(`Analysis Neighborhood`),
    -(`Time Horizon`),
    -(`Median Year Structure Build`),
    -(`Population Density per Acre`)
  )
crime_demostats_2014_2016 <-
  crime_demostats_2014_2016[, c(-38,-39)]
crime_demostats_2014_2016[is.na(crime_demostats_2014_2016)] <- 1
crime_demostats_2014_2016[crime_demostats_2014_2016 == "0"] <- 1

datatable(
  crime_demostats_2014_2016,
  rownames = FALSE,
  filter = "top",
  options = list(pageLength = 5, scrollX = T)
)
```

```{r}
crime_demostats_2016geo <-
  bind_cols(crime_demostats_2016, neigh) %>%
  select(everything()) %>% arrange(`Analysis Neighborhood`)

crime_demostats_2016geo <- crime_demostats_2016geo[, c(-38, -39, -41)]
```

<br><br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
Now that our data has been cleaned up, we can move on to the anaytical parts of our project.
</div>
<br>
