# 3 Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## 3.1 Crime EDA

For the first part of the exploratory data analysis, we are going to be interested in how crime is organized over time. Can we see patterns that recur at certain times of the day, at certain times of the year?

### 3.1.1 Date/Time Crime Tendency

#### 3.1.1.1 Hour Crime Tendency

```{r}
sephour <-
  crime2003_2020 %>% separate(`Incident Time`,
                              into = c("hour", "min", "sec"),
                              sep = "[:]+")
#separate the time to have a column of hours, minutes and seconds. All this to have intervals by hours of the crimes.

kable(head(sephour %>% count(hour, name = "hour of the day") %>% arrange(desc(`hour of the day`))), "simple")
```

This table shows the number of crimes falling within an interval of 1 hour. We can still see a certain trend with these numbers. It has more crimes in the time interval [3pm-8pm], at noon and midnight. It is interesting to note that the first 3 time intervals that have the most crimes are 6pm, 5pm and 12pm. These schedules are often when workers have breaks or have finished working.

We can also show this global tendencies with a barplot.

```{r}
countsephour <-
  sephour %>% count(hour, name = "number of crime") %>% arrange(desc(`number of crime`))

countsephour %>% ggplot(aes(x = hour, y = `number of crime`)) + labs(title = "Distribution of crime by hourday") +
  geom_bar(stat = "identity", fill = "#2b8cbe")
#draw the discrete distribution of the tendendices of crime given the hour of the day.
```

We can see that as early as 8:00 a.m., crimes increase little by little. We see the peak at 12 o'clock. And the time of the day when there is the most crime (the interval [3pm-8pm]). What is interesting to note is that there is less crime at night. Whereas at first glance one would think that crimes take place more at night.

We also wanted to see if the trend in the number of crimes was different on different days of the week.

```{r}
g <-
  sephour %>% group_by(hour, `Incident Day of Week`) %>% count(`Incident Day of Week`, name = "number of crime")

g %>% ggplot(aes(hour, `number of crime`)) +
  geom_linerange(
    aes(
      x = hour,
      ymin = 0,
      ymax = `number of crime`,
      group = `Incident Day of Week`
    ),
    color = "lightgray",
    size = 1.5,
    position = position_dodge(0.3)
  ) +
  geom_point(aes(color = `Incident Day of Week`),
             position = position_dodge(0.3),
             size = 1) + facet_wrap( ~ `Incident Day of Week`, scales = 'free') +
  scale_color_manual(values = c(
    "#2b8cbe",
    "#2b8cbe",
    "#2b8cbe",
    "#2b8cbe",
    "#2b8cbe",
    "#2b8cbe",
    "#2b8cbe"
  ))
```

For the days of the week (Monday, Tuesday, Wednesday, Thursday), we see the same trend: a gradual increase until 6pm, with a sudden peak at noon and a gradual decrease after 6pm. On the other hand, for Friday, Saturday and Sunday the increase lasts until later in the evening. We can certainly explain this by the fact that thanks to the night life.

#### 3.1.1.2 Day Crime Tendency

We are now going to look at the distribution of crimes according to the days of the week. It seems logical that crimes increase on Fridays and Saturdays because that's when people go out the most. But is this really the case?

```{r, out.width = '100%'}
countsepday <-
  crime_2016 %>% count(`Incident Day of Week`, name = "number of crime")

options(scipen = 999)

countsepday %>%
  ggplot(aes(x = `Incident Day of Week`, y = `number of crime`)) +
  labs(title = "Distribution of crime by weekday") +
  geom_bar(stat = "identity", fill = "#2b8cbe") +
  geom_text(aes(label = `number of crime`), position = position_dodge(width = 0.9), vjust = -0.25)
```

There is definitely more crime on Fridays than on any other day of the week. However, the variation between days is not obvious.

#### 3.1.1.3 Month Crime Tendency (2016 Focus)

We found it interesting to look at the distribution of the number of crimes per month, to see if there was an increase or decrease in some months. As we will refine our analysis later on in 2016, we will choose to analyze the variation in the number of crimes per month over the year 2016.
```{r}
countsepmonth <-
  crime_2016 %>% count(month, name = "number of crime")
options(scipen = 999)
countsepmonth %>% ggplot(aes(x = month, y = `number of crime`)) + labs(title = "Distribution of crime by weekday") + geom_bar(stat = "identity", fill = "#2b8cbe") + geom_text(aes(label = `number of crime`),
                                                                                                                                                                               position = position_dodge(width = 0.9),
                                                                                                                                                                               vjust = -0.25)
```

We don't see any particular pattern. There is some variation but no clear distinction. One would have thought that the months with warm weather might have influenced the increase in crime because people are going out more and have more positive energy. But the variation between the months is small, we can't conclude anything with that.


```{r}
og <-
  crime_2016 %>% group_by(day, month) %>% count(month, name = "number of crime")

og %>% ggplot(aes(day, `number of crime`)) +
  geom_linerange(
    aes(
      x = day,
      ymin = 0,
      ymax = `number of crime`,
      group = month
    ),
    color = "lightgray",
    size = 1.5,
    position = position_dodge(0.3)
  ) +
  geom_point(aes(color = month),
             position = position_dodge(0.3), size = .1) + facet_wrap( ~ month, scales =
                                                                        'free') +
  scale_color_manual(
    values = c(
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe",
      "#2b8cbe"
    )
  )
```
If we look at how the number of crimes evolves every day by comparing each month, we still don't see any clear pattern. The variation seems to be constant.

#### 3.1.1.4 Year [2003-2020] Crime Tendency

We will look at the evolution of the number of crimes per month over a period of 13 years. We will then draw a time graph over the period [2003-2020].

```{r}
crime_number <-
  crime2003_2020  %>% arrange(`Incident Time`) %>%  arrange(`Incident Date`) %>%
  add_column(crime = 1) %>% select(crime, `Incident Date`)
#establish the number of crime from 2003 to 2017

crime_number_monhtly <- crime_number %>%
  mutate(month = month(`Incident Date`, label = TRUE),
         year  = year(`Incident Date`)) %>%
  group_by(year, month) %>%
  summarise(`Crime per Month` = sum(crime)) %>% mutate(`Month` = make_date(year, month)) %>%
  select(`Month`, `Crime per Month`)
#group the number of crime per month given the time period 2003 to 2017

library(hrbrthemes)
ggplot(crime_number_monhtly, aes(x = `Month`, y = `Crime per Month`)) +
  geom_smooth(se = F) +
  geom_line(color = "#69b3a2") + labs(title = "Evolution of the crime number per month : Year = [2003-2020]") + xlab("Year") + ylab("Number of Crime")
```

There is minor variation (with greater or lesser intensity) between months over time. We have chosen to smooth these temporal data, using the function that is part of R base loess. With this smoothing, we can see a certain sinusoidal variation with a decrease in the smoothed line when we get to the crisis years of 2008, followed by an increase until 2016, when we reach a maximum. Then a descent. Note the clear and precise fall when we get to 2020: we'll come back to this later. 

## 3.1.2 Crime Category Tendency

We will now turn our attention to the categories of crime. What is San Francisco most affected by?

```{r}
countcat <-
  head(crime2003_2020 %>% count(`Incident Category`, name = "category") %>% arrange(desc(category))) #Show the first 6 categories with the most crime

countcat %>% ggplot(aes(x = `Incident Category`, y = category)) +
  geom_bar(stat = "identity", fill = "#2b8cbe") + labs(title = "Number of Crime per Category") + xlab("Crime Category") + ylab("Number of Crime")
#Count the number of crimes by category and draw the discrete distribution 
```
The trends are clear! The vast majority of crime in San Francisco is theft. The `Theft` bar of the barplot clearly dominates the others. If we also consider column `Motor Vehicle Theft`, which can be considered theft, we can conclude that crime in San Francisco is mainly focused on property crimes.


```{r}
heatmap_cat_hour <-
  crime2003_2020 %>% filter(
    `Incident Category` %in% c(
      "Larceny/Theft",
      "Other",
      "Non-Criminal",
      "Assault",
      "Motor Vehicle Theft"
    )
  ) %>% separate(`Incident Time`,
                 into = c("hour", "min", "sec"),
                 sep = "[:]+") %>% select(hour, `Incident Category`) %>% group_by(hour, `Incident Category`) %>% count(`Incident Category`)

heatmap_cat_hour %>% ggplot(aes(hour, `Incident Category`, fill = n)) +
  geom_tile()
```

```{r}
crime2003_2020 %>% filter(
    `Incident Category` %in% c(
      "Larceny/Theft",
      "Other",
      "Non-Criminal",
      "Assault",
      "Motor Vehicle Theft"
    )
) %>%  group_by(`Incident Day of Week`, `Incident Category`, ) %>% count(`Incident Category`) %>% ggplot(aes(`Incident Day of Week`, `Incident Category`, fill = n)) + geom_tile()
```

```{r, fig.width=10, fig.height=2, fig.fullwidth=TRUE, out.width = '100%'}

p1 <-
  crime2003_2020 %>% filter(`Incident Category` %in% c("Larceny/Theft")) %>%  group_by(`Incident Day of Week`, `Incident Category`, ) %>% count(`Incident Category`) %>% ggplot(aes(`Incident Day of Week`, `Incident Category`, fill = n)) + geom_tile()

p2 <-
  crime2003_2020 %>% filter(`Incident Category` %in% c("Other")) %>%  group_by(`Incident Day of Week`, `Incident Category`, ) %>% count(`Incident Category`) %>% ggplot(aes(`Incident Day of Week`, `Incident Category`, fill = n)) + geom_tile()

p3 <-
  crime2003_2020 %>% filter(`Incident Category` %in% c("Non-Criminal")) %>%  group_by(`Incident Day of Week`, `Incident Category`, ) %>% count(`Incident Category`) %>% ggplot(aes(`Incident Day of Week`, `Incident Category`, fill = n)) + geom_tile()

p4 <-
  crime2003_2020 %>% filter(`Incident Category` %in% c("Assault")) %>%  group_by(`Incident Day of Week`, `Incident Category`, ) %>% count(`Incident Category`) %>% ggplot(aes(`Incident Day of Week`, `Incident Category`, fill = n)) + geom_tile()

p5 <-
  crime2003_2020 %>% filter(`Incident Category` %in% c("Motor Vehicle Theft")) %>%  group_by(`Incident Day of Week`, `Incident Category`, ) %>% count(`Incident Category`) %>% ggplot(aes(`Incident Day of Week`, `Incident Category`, fill = n)) + geom_tile()


p1 + p2 + p3 + p4 + p5

```

## 3.1.3 Crime Across Neighborhood

We will now represent geographic visualizations to better understand where the places with the most crime in San Francisco are. The objective is to draw conclusions with the socio-economic characteristics of the neighborhoods.

```{r}
crime2003_2020 %>%
  count(`Analysis Neighborhood`, name = "number of crime") %>%
  arrange(desc(`number of crime`)) %>%
  ggplot(aes(x = `Analysis Neighborhood`, y = `number of crime`)) +
  geom_bar(stat = "identity", fill = "#2b8cbe", alpha = .7) +
  labs(title = "Number of Crime per Category") + xlab("SF Neighborhood") + ylab("Number of Crime") + coord_flip()

```
The neighbourhoods with the most crime are Tenderloin, South of Market and Mission. There is also the Financial District and Bayview Hunters Point, which are quite a bit affected by crime.

```{r}
blue <- colorNumeric("YlGnBu", crime_demostats_2016$`Total crimes`)

leaflet(height=500, width=500) %>% addTiles() %>% #create a variable leaflet on which we add the map Tiles
  setView(-122.42, 37.78, zoom = 11) %>% # Precise the map target on San Francisco
  addPolygons(
    data = neigh$geometry,
    col = "black",
    weight = 1,
    fillColor = blue(crime_demostats_2016$`Total crimes`),
    fillOpacity = 0.7
  ) %>% # Add the multipolygon data set in order to show the neighborhood segmentation
  addMarkers(
    lng = crime_2016$lon,
    lat = crime_2016$lat,
    popup = crime_2016$`Incident Category`,
    clusterOptions = markerClusterOptions()
  ) %>% #add a marker for every point of the data set and cluster those points
  addProviderTiles(providers$MtbMap) %>%
  addProviderTiles(providers$Stamen.TonerLines,
                   options = providerTileOptions(opacity = 1)) %>%
  addProviderTiles(providers$Stamen.TonerLabels) #change the design of the map #change the design of the map. We can see now how the road and transport is construct.
```

We built an interactive map of San Francisco highlighting the transportation infrastructure. You can walk around the map by zooming in on the city's neighborhoods. By segmenting the city by neighborhood, we have highlighted the neighborhoods where there is the most crime. The darker the blue, the more crime. We can see that the neighborhoods with the most crime are those with the most black roads. We'll look later, but it would be interesting to see if the transportation infrastructure has a statistical relationship with the number of crimes
The three dark blue neighbourhoods are the ones previously mentioned: Tenderloin, South of Market, Mission. The 3 three light blue neighbourhoods are: Financial District and Bayview Hunters Point
You can also see orange bubbles. These orange bubbles group together the crimes that took place in San Francisco in 2016. They coordinate well with the overall crime trends that are analyzed with the blue gradients.


## 3.1.4 Crime Resolution


While doing some research on the crime situation in San Francisco, we came across an article ([https://www.sfchronicle.com/bayarea/philmatier/article/SF-ranks-high-in-property-crime-while-it-ranks-14439369.php]) that explained that criminals can't be arrested. We wanted to see if this data had the same conclusions.


```{r}
piechartres <-
  head(crime2003_2020 %>% count(Resolution, name = "resolution") %>% arrange(desc(resolution)))

ggplot(piechartres, aes(x = "", y = resolution, fill = Resolution)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) + scale_fill_manual(values = c(
    "#f1eef6",
    "#d0d1e6",
    "#a6bddb",
    "#74a9cf",
    "#2b8cbe",
    "#045a8d"
  )) + xlab(" ") + ylab(" ") + labs(title = "Proportion of the Resolution") + theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )
```


We see very clearly that the majority of crimes have no follow-up. Less than a quarter are arrested. We want to analyze this further. Are certain categories more affected by having no follow-up?


```{r}

k <-
  crime2003_2020 %>% group_by(Resolution, `Incident Category`) %>% count(Resolution, name = "resolution")
options(scipen = 999)
k %>% filter(
    `Incident Category` %in% c(
      "Larceny/Theft",
      "Other",
      "Non-Criminal",
      "Assault",
      "Motor Vehicle Theft" 
    )
) %>% ggplot(aes(x = resolution,
                 y = `Incident Category`,
                 fill = Resolution)) + scale_fill_manual(
                   values = c(
                     "#543005",
                     "#8c510a",
                     "#bf812d",
                     "#dfc27d",
                     "#f6e8c3",
                     "#f5f5f5",
                     "#c7eae5",
                     "#c7eae5",
                     "#35978f",
                     "#01665e",
                     "#003c30",
                     "#2b8cbe",
                     "#636363"
                   )
                 ) +
  geom_bar(position = "stack", stat = "identity") + ylab("Crime Category") + xlab("Number of Crime") + labs(title = "Crime Resolution Given the Crime Category")
```
What marks with this graph is the bar that represents the number of theft. In fact, there is no continuation for the large majority of the thefts (normal or those of vehicles). In San Francisco, crime is mostly focused on theft. And the majority of thieves don't get caught.
Now we understand why San Francisco is one of the cities with a crime rate above the national average and why San Francisco is one of the cities with the most violent crime in California. Because theft is considered a violent crime, San Francisco is infested with thieves


### 3.2 Transport Across Neighborhood

We start from the premise that public transport is a vector that makes life easier for criminals. It's easy to steal in transportation because a lot of people are tight, it's also easy to steal in neighborhoods where there is transportation because you can run away very quickly. We wanted to see the importance and if there was any connection between the number of transport stops and the number of crimes.

```{r}
numstops <-
  crime_demostats_2016 %>% select(`Violent crimes`, `number of stops`, `Analysis Neighborhood`) %>% arrange(desc(`number of stops`))
  
kable(head(numstops), "simple")
```

Just with this table, it's hard to conclude anything. It would still seem that some neighbourhoods with a lot of crime are not at the top of the rankings when it comes to the number of public transport stops.

### 3.3 COVID data

```{r}
ggplot(covid_sf, aes(`Specimen Collection Date`, `Case Count`)) +
  geom_line()
```

```{r}
ggplot(covid_neighborhoods, aes(reorder(`id`, `rate`), `rate`)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

### 3.4 Socio-Demographic data


```{r}
biggest_neighborhoods <- demostats_2016 %>%
  arrange(desc(`Total Population`)) %>%
  head() %>%
  rename(Neighborhood = NEIGHBORHOOD)


ggplot(biggest_neighborhoods,
       aes(`Neighborhood`,  `Total Population`)) +
  geom_bar(stat = "identity")

```

```{r}
library(reshape2)
biggest_neighborhoods_long <- melt(biggest_neighborhoods)

biggest_neighborhoods_long_households <-
  biggest_neighborhoods_long %>%
  filter(variable %in% c("Family Households", "Non-Family Households"))


ggplot(
  biggest_neighborhoods_long_households,
  aes(`Neighborhood`, `value`, fill = `variable`)
) +
  geom_bar(stat = "identity", position = "dodge")

```

```{r}
biggest_neighborhoods_long_race <-  biggest_neighborhoods_long %>%
  filter(
    variable %in% c(
      "Asian",
      "Black/African American",
      "White",
      "Native American Indian",
      "Native Hawaiian/Pacific Islander",
      "Other/Two or More Races"
    )
  )

ggplot(biggest_neighborhoods_long_race,
       aes(`Neighborhood`, `value`, fill = `variable`)) +
  geom_bar(stat = "identity") 
```

```{r}
biggest_neighborhoods_long_age <-  biggest_neighborhoods_long %>%
  filter(variable %in% c(
    "60 and older",
    "35-59 years",
    "18-34 years",
    "5-17 years",
    "0-4 years"
  ))

ggplot(biggest_neighborhoods_long_age,
       aes(`Neighborhood`, `value`, fill = `variable`)) +
  geom_bar(stat = "identity", position =  position_stack(reverse = TRUE)) 
```

```{r}
biggest_neighborhoods_long_education <-
  biggest_neighborhoods_long %>%
  filter(
    variable %in% c(
      "High School or Less",
      "Some College/Associate Degree",
      "College Degree",
      "Graduate/Professional Degree"
    )
  )

ggplot(
  biggest_neighborhoods_long_education,
  aes(`Neighborhood`, `value`, fill = `variable`)
) +
  geom_bar(stat = "identity", position =  position_stack(reverse = TRUE))

```

